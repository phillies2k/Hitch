/**
 * Hitch.js - v0.0.2
 * Lightweight backbone based single page application framework
 *
 * @author: Philipp Boes <mostgreedy@gmail.com>
 * @copyright: (c) 2012 Philipp Boes
 * @version: 0.0.2
 *
 */((function(){var a=this,b=a.Backbone,c=a._,d=a.ObjectId,e=a.Hitch={},f;if(!c)throw new Error("Hitch requires underscore.");if(!b)throw new Error("Hitch requires backbone.");if(!d)throw new Error("Hitch requires ObjectId.");f=b.Router.extend,e.VERSION="0.0.2",e.ACL=function(a){this.permissions={},a instanceof e.Object||a instanceof e.Resource?(this.setReadAccess(a,!0),this.setWriteAccess(a,!0)):c.isObject(a)&&c.each(a,function(a,b){this.permissions[b]={},c.each(a,function(a,c){this.permissions[b][c]=a},this)},this)},e.ACL.PUBLIC="PUBLIC",e.ACL.prototype={constructor:e.ACL,_determineUserId:function(a){return a instanceof e.User?a.id:a instanceof e.Role?"role:"+a.getName():a instanceof e.Resource?"resource:"+a.name:c.isObject(a)?a.toString():a},_getAccess:function(a,b){var c;return b=this._determineUserId(b),c=this.permissions[b],c&&c[a]},_setAccess:function(a,b,d){var e;b=this._determineUserId(b),e=this.permissions[b];if(!e){if(!d)return;e={},this.permissions[b]=e}d?this.permissions[b][a]=!0:(delete e[a],c.isEmpty(e)&&delete e[b])},getPublicReadAccess:function(){return this._getAccess("read",e.ACL.PUBLIC)},setPublicReadAccess:function(a){this._setAccess("read",e.ACL.PUBLIC,a)},getRoleReadAccess:function(a){return this._getAccess("read",a)},setRoleReadAccess:function(a,b){this._setAccess("read",a,b)},getReadAccess:function(a){return this._getAccess("read",a)},setReadAccess:function(a,b){this._setAccess("read",a,b)},getWriteAccess:function(a){return this._getAccess("write",a)},setWriteAccess:function(a,b){this._setAccess("write",a,b)},getPublicWriteAccess:function(){return this._getAccess("write",e.ACL.PUBLIC)},setPublicWriteAccess:function(a){this._setAccess("write",e.ACL.PUBLIC,a)},getRoleWriteAccess:function(a){return this._getAccess("write",e.ACL.PUBLIC)},setRoleWriteAccess:function(a,b){this._setAccess("write",a,b)},toJSON:function(){return c.clone(this.permissions)}},e.Object=b.Model.extend({idAttribute:"_id",isStoredLocally:!1,storageKey:null,acl:null,relations:{},getACL:function(){return this.acl||(this.acl=new e.ACL(this)),this.acl},set:function(a,d){return c.each(this.relations,function(c,e){var f=this[e];f||(a[e]&&(a[e]instanceof b.Model||a[e]instanceof b.Collection)?f=this[e]=a[e]:f=this[e]=new c),a[e]&&(f[f instanceof b.Collection?"reset":"set"](a[e],d),a[e]=f.toJSON())},this),a[this.idAttribute]&&c.isObject(a[this.idAttribute])&&c.has(a[this.idAttribute],"$id")&&(a[this.idAttribute]=a[this.idAttribute].$id),b.Model.prototype.set.call(this,a,d)},sync:function(a,b,c){return e.sync.call(this,a,b,c)},toJSON:function(){var a=c.clone(this.attributes);return c.each(c.keys(this.relations),function(b){a[b]=this[b].toJSON()},this),a}}),e.Role=e.Object.extend({defaults:{name:"anonymous"},getName:function(){return this.get("name")},setName:function(a,b){return this.set("name",a,b)}}),e.User=e.Object.extend({loggedIn:!1,relations:{role:e.Role},isLoggedIn:function(){return this.loggedIn}}),e.Credentials=e.Object.extend({userAttribute:"username",passAttribute:"password",validate:function(a){if(!a||!$.isPlainObject(a))return"invalid credentials.";if(!a[this.userAttribute])return"no "+this.userAttribute+" given.";if(!a[this.passAttribute])return"no "+this.passAttribute+" given."},initialize:function(a,b){b=b||{},b.user&&b.user instanceof e.User?this.user=b.user:this.user=new e.User,b.url&&(this.url=b.url)},fetch:function(a){var b,d;return a=a||{},a.success&&(b=a.success),a.error&&(d=a.error),a.data=this.toJSON(),a.type="POST",a.success=c.bind(function(a){this.user.loggedIn=!0,this.user.set(a),e.Cookies.set("hitch-user",this.user.id),b&&b(this,a)},this),a.error=c.bind(function(a){e.Cookies.clear("hitch-user"),this.user.loggedIn=!1,this.user.clear({silent:!0}),d&&d(this,a)},this),e.Object.prototype.fetch.call(this,a)}}),e.Resource=b.Collection.extend({operators:"$eq $in $or $gt $gte $lt $lte".split(" "),model:e.Object,getACL:e.Object.prototype.getACL,setACL:e.Object.prototype.setACL,find:function(a,b){var d;return c.isEmpty(a)?this.models:(d=this.filter(function(b){for(var c in a)if(!this._evaluateCriteria(b,c,a[c],null))return!1;return!0},this),b.limit?c.first(d,b.limit):d)},findOne:function(a){if(!$.isPlainObject(a))return;return this.find(a,{limit:1})},_evaluateCriteria:function(a,b,d,e){function f(a,b,c){if(!c)return a==b;switch(c){case"$eq":return a===b;case"$in":return a.indexOf(b)>=0;case"$or":return a||b;case"$gt":return a>b;case"$gte":return a>=b;case"$lt":return a<b;case"$lte":return a<=b;default:return!1}}if(this.operators.indexOf(b)===-1)return f(a.get(b),d,e);if(c.isObject(d)){for(var g in d)if(!this._evaluateCriteria(a,g,d[g],b))return!1;return!0}}}),e.Router=function(a){a=a||{},a.resource&&(this.resource=a.resource),a.routes&&(this.routes=a.routes),this._bindFilters(),this._bindRoutes(),this.initialize.apply(this,arguments)},e.Router.extend=f,c.extend(e.Router.prototype,b.Router.prototype,{constructor:e.Router,_displaySlots:{},_filters:{},onAfter:function(a,b,d){this._addFilter.apply(this,["after"].concat(c.toArray(arguments)))},onBefore:function(a,b,d){this._addFilter.apply(this,["before"].concat(c.toArray(arguments)))},route:function(a,d,e){return c.isRegExp(a)||(a=this._routeToRegExp(a)),e||(e=this[d]),b.history.route(a,c.bind(function(c){var f=this._extractParameters(a,c);this._applyFilters("before",c,f)&&(e&&e.apply(this,f),this._applyFilters("after",c,f),this.trigger.apply(this,["route:"+d].concat(f)),b.history.trigger("route",this,d,f))},this)),this},showView:function(a,b){return this._displaySlots[a]&&this._displaySlots[a].close(),$(a).html(b.render().el),b.open(),this._displaySlots[a]=b,b},_addFilter:function(a,b,d,e){var f;this._filters[a]||(this._filters[a]={}),this._filters[a][b]||(f=this._filters[a][b]=[]),f[f.length]=c.bind(d,e||this)},_applyFilters:function(a,b,d){var e=a+"All",f=c.has(this,e)?this[e]:!1,g,h;return!this._filters[a]||c.isEmpty(this._filters[a])?!0:(g=c.filter(this._filters[a],function(a,d){return c.isRegExp(d)||(d=this._routeToRegExp(d)),d.test(b)},this),h=c.isEmpty(g)||!c.find(g,function(a,b){var e=[];return c.each(a,function(a){var b=c.isFunction(a)?a.apply(this,d):this[a].apply(this,d);e.push(c.isBoolean(b)&&b===!1)},this),c.compact(e).length===0},this),c.isFunction(f)&&(h=h&&f()),h)},_bindFilters:function(){for(var a in this.after)this._addFilter("after",a,this.after[a]);for(var b in this.before)this._addFilter("before",b,this.before[b])}}),e.View=function(a){a&&a.resource&&(this.resource=a.resource),b.View.prototype.constructor.call(this,a)},e.View.extend=f,c.extend(e.View.prototype,b.View.prototype,{delegateBindings:function(){c.each(c.toArray(this.$("[data-bind]")),function(a){var b=$(a).data("bind"),c=$(a).data("bind-attribute");this.model.on("change:"+b,function(){c?$(a).attr(c,this.model.get(b)):$(a).html(this.model.get(b))},this)},this)},close:function(){this.beforeClose&&this.beforeClose(),this.undelegateEvents(),this.remove()},open:function(a){this.delegateEvents(),this.delegateBindings(),this.beforeOpen&&(this.$el.hide(),this.beforeOpen(c.bind(function(){this.$el.show()},this)))}}),e.App=function(a){a=a||{},$.isPlainObject(a)||(a=c.object(["name","apiUrl","baseRoute"],c.toArray(arguments))),a.apiUrl&&(this.apiUrl=a.apiUrl),a.baseRoute&&(this.baseRoute=a.baseRoute),a.name&&this.setName(a.name),c.isRegExp(this.baseRoute)||(this.baseRoute=b.Router.prototype._routeToRegExp(this.baseRoute)),b.history.route(/^(.+?)$/,c.bind(function(a){var c=b.Router.prototype._extractParameters(/^(.*?)$/,a);this.error.apply(this,c),this.trigger.apply(this,["route:error"].concat(c)),b.history.trigger("route",this,"error",c)},this)),b.history.route(this.baseRoute,c.bind(function(a){var c=b.Router.prototype._extractParameters(this.baseRoute,a);this.index.apply(this,c),this.trigger.apply(this,["route:index"].concat(c)),b.history.trigger("route",this,"index",c)},this)),this.pushState&&$("a[href]").live("click",function(a){var c=$(this).attr("href");!$(this).attr("target")&&!/^(http\:\/\/|www\.)/.test(c)&&(a.preventDefault(),b.history.navigate(c,!0))}),this.on("ready",this.ready,this),this.initialize.call(this,c.toArray(arguments))},e.App.extend=f,c.extend(e.App.prototype,b.Events,{baseRoute:/^$/,apiUrl:"",pushState:!1,exports:!1,name:"app",getName:function(){return this.name},setName:function(a){this.name=document.title=a||document.title},getBaseRoute:function(){return this.baseRoute},getPublicInterface:function(){var a=c.filter(c.keys(this),function(a){return a.charAt(0)!=="_"});return c.pick(this,a)},appendAsset:function(a,b){a==="stylesheet"?$('<link rel="stylesheet" type="text/css" href="'+b+'">').appendTo("head"):a==="javascript"&&$('<script type="text/javascript" src="'+b+'"></script>').appendTo("head")},load:function(a){var b,d=0;c.isArray(a)||(a=c.toArray(arguments)),b=a.length,this.resources={},c.each(a,function(a){c.isFunction(a)&&(a=new a),a.name||(a.name=c.uniqueId("r")),this.apiUrl&&(a.url=[this.apiUrl,a.name].join("/")),a.fetch({success:c.bind(function(a){this.resources[a.name]=a,++d===b&&this.trigger("ready",this.resources)},this)})},this)},run:function(){b.history.start({pushState:this.pushState});if(this.exports){var d=c.isString(this.exports)?this.exports:this.name;a[d]=this.getPublicInterface()}},initialize:function(){},ready:function(){},index:function(){},error:function(){}}),e.sync=function(a,d,e){var f=e.success,g;return d.isStoredLocally?(d.storageKey||(d.storageKey=c.uniqueId("h")),g=localStorage.getItem(d.storageKey),a==="create"||a==="update"?(g=d.toJSON(),localStorage.setItem(d.storageKey,JSON.stringify(g))):a==="read"?g=g&&JSON.parse(g):a==="destroy"&&g&&localStorage.removeItem(d.storageKey),f&&f(g),!0):b.sync(a,d,e)},e.Cookies={get:function(a){return!a||!this.has(a)?null:unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))},set:function(a,b,d,e,f,g){var h={};if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return;h[a]=escape(b),c.extend(h,c.object(["expires","path","domain","secure"],c.rest(c.toArray(arguments),2))),h.expires&&h.expires.constructor===Number?h.expires===Infinity?h.expires="Tue, 19 Jan 2038 03:14:07 GMT":(h["max-age"]=h.expires,delete h.expires):h.expires&&h.expires.constructor===Date?h.expires=h.expires.toGMTString():h.expires&&h.expires.constructor!==String&&delete h.expires,document.cookie=c.compact(c.map(c.pairs(h),function(a){return!c.isUndefined(a[1])&&a.join("=")})).join(";")},clear:function(a,b){if(!a||!this.has(a))return;document.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(b?"; path="+b:"")},has:function(a){return c.indexOf(this.names(),a)!==-1},names:function(){return c.map(document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),function(a){return unescape(a)})}},e.Helpers={createdAt:function(a){return(new d(a)).getDate()},formField:function(a,b,d){function f(a){$("label[for^="+k+"]").removeClass("error"),$(j).removeClass("error").next("span").remove(),l=$(j).val()}function g(c){var e={},f=$(j).val();if(l===h)return;d.prop?(e[b]={},e[b][d.prop]=f):e[b]=f,a.on("error",function(a,b){$("label[for^="+k+"]").addClass("error"),$(j).addClass("error").val(l).insertAfter($("<span></span>").text(b))}),a.set(e),d.save&&a.save()}var h=a.get(b),i,j="#"+b+(a.isNew()?"":"-"+a.id),k=j.substring(1),l=$(j).val(),m="input",n=b,o={id:k,value:h};return d=d||{},c.isBoolean(d)&&(d={save:d}),c.isString(d)&&(d={label:d}),d.label&&(n=d.label),d.password&&(i="password"),d.placeholder&&(o.placeholder=d.placeholder),d.prop&&h&&c.has(h,d.prop)&&(h=o.value=h[d.prop]),i=o.type=i||(c.isBoolean(h)?"checkbox":c.isNumber(h)?"number":"text"),d.text?(m="textarea",o=c.pick(o,"id","placeholder")):d.source instanceof e.Resource&&(m="select",o=c.pick(o,"id","placeholder"),c.each(d.source,function(a){c.tagFor("option",{value:a.get()},a.get())})),c.inDom(j,function(){$(j).on("focus",f),$(j).on("blur",g)}),c.tagFor("dt",c.tagFor("label",{"for":k},n))+c.tagFor("dd",c.tagFor(m,o,d.text&&h))},inDom:function(a,b){var c,d;(c=function(){if(!$(a).length)return d=setTimeout(c,20);d&&clearTimeout(d),b()})()},tagFor:function(a,b,d){var e="link input meta".split(" ");return b&&!d&&!c.isObject(b)&&(d=b,b={}),"<"+a+" "+c.flatten(c.map(c.pairs(b),function(a){return a.join('="')+'"'})).join(" ")+">"+(d?d:"")+(e.indexOf(a)>=0?"":"</"+a+">")},ucFirst:function(a){return a.charAt(0).toUpperCase()+a.substring(1)},lcFirst:function(a){return a.charAt(0).toLowerCase()+a.substring(1)}},c.mixin(e.Helpers)})).call(this);