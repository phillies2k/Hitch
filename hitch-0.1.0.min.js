/**
 * Hitch.js - v0.1.0
 * Lightweight backbone based single page application framework
 *
 * @author: Philipp Boes <mostgreedy@gmail.com>
 * @copyright: (c) 2012 Philipp Boes
 * @version: 0.1.0
 *
 */((function(){var a=this,b=a.Backbone,c=a._,d=a.Hitch={},e;if(!c)throw new Error("Hitch requires underscore.");if(!b)throw new Error("Hitch requires backbone.");e=b.Router.extend,d.VERSION="0.1.0",d.Access={acl:null,getACL:function(){return this.acl||(this.acl=new d.ACL),this.acl},setACL:function(a){if(!a instanceof d.ACL)throw new Error("acl must be an instance of Hitch.ACL");this.acl=a}},d.Cookies={get:function(a){return!a||!this.has(a)?null:unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))},set:function(a,b,d,e,f,g){var h={};if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return;h[a]=escape(b),c.extend(h,c.object(["expires","path","domain","secure"],c.rest(c.toArray(arguments),2))),h.expires&&h.expires.constructor===Number?h.expires===Infinity?h.expires="Tue, 19 Jan 2038 03:14:07 GMT":(h["max-age"]=h.expires,delete h.expires):h.expires&&h.expires.constructor===Date?h.expires=h.expires.toGMTString():h.expires&&h.expires.constructor!==String&&delete h.expires,document.cookie=c.compact(c.map(c.pairs(h),function(a){return!c.isUndefined(a[1])&&a.join("=")})).join(";")},clear:function(a,b){if(!a||!this.has(a))return;document.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(b?"; path="+b:"")},has:function(a){return c.indexOf(this.names(),a)!==-1},names:function(){return c.map(document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),function(a){return unescape(a)})}},d.Helpers={formField:function(a,b,d){function e(a){$("label[for^="+k+"]").removeClass("error"),$(j).removeClass("error").next("span").remove(),l=$(j).val()}function f(c){var e={},f=$(j).val();if(l===h)return;d.prop?(e[b]={},e[b][d.prop]=f):e[b]=f,a.on("error",function(a,b){$("label[for^="+k+"]").addClass("error"),$(j).addClass("error").val(l).insertAfter($("<span></span>").text(b))}),a.set(e),d.save&&a.save()}function g(a){$(j).on("focus",e),$(j).on("blur",f)}var h=a.get(b),i,j="#"+b+(a.isNew()?"":"-"+a.id),k=j.substring(1),l=$(j).val(),m="input",n=b,o={id:k,value:h},p="div";return d=d||{},c.isBoolean(d)&&(d={save:d}),c.isString(d)&&(d={label:d}),d.label&&(n=d.label),d.fieldEl&&(labelEl=d.fieldEl),d.password&&(i="password"),d.placeholder&&(o.placeholder=d.placeholder),d.prop&&h&&c.has(h,d.prop)&&(h=o.value=h[d.prop]),d.text&&(m="textarea",o=c.pick(o,"id","placeholder")),i=o.type=i||(c.isBoolean(h)?"checkbox":c.isNumber(h)?"number":"text"),c.inDom(j,g),c.tagFor(p,{id:"ff-"+k,"class":"form-field"},[c.tagFor("div",{"class":"form-field-name"},[c.tagFor("label",{"class":"form-field-label","for":k},n),c.tagFor("span",{"class":"form-field-description"},d.description)]),c.tagFor(m,o,d.text&&h)])},inDom:function(a,b){var c=0,d;(function e(){if(++c>1e3)return;if(!$(a).length)return d=setTimeout(e,0);d&&clearTimeout(d),b()})()},tagFor:function(a,b,d){var e="link input meta".split(" ");return b&&!d&&!c.isObject(b)&&(d=b,b={}),"<"+a+" "+c.flatten(c.map(c.pairs(b),function(a){return a[0]=a[0].replace(/([a-z])([A-Z])/,function(a){return a[0]+"-"+a[1].toLowerCase()}),a.join('="')+'"'})).join(" ")+">"+(d?c.isArray(d)?d.join(""):d:"")+(e.indexOf(a)>=0?"":"</"+a+">")},ucFirst:function(a){return a.charAt(0).toUpperCase()+a.substring(1)},lcFirst:function(a){return a.charAt(0).toLowerCase()+a.substring(1)}},c.mixin(d.Helpers),d.ACL=function(a,b){this._publicPermissions={},this._routePermissions={},$.isPlainObject(a)&&a.public&&a.routes&&(this._publicPermissions=a.public,this._routePermissions=a.routes)},d.ACL.prototype={constructor:d.ACL,getAccess:function(a,b){var c;if(!b instanceof d.Object)throw new Error("second argument must be an instance of Hitch.Object");return this._publicPermissions[a]||!this._routePermissions[a]?!0:(c=this._routePermissions[a],!!c[b.id])},setAccess:function(a,b,d){if(!a)throw new Error("setAccess requires at least one argument: the route.");if(c.isUndefined(b)||b===!0)return this._publicPermissions[a]=!0,!0;c.isUndefined(d)&&(d=!0),c.isBoolean(d)||(d=!!d),a==="*"?this._publicPermissions[a]=d:(this._routePermissions[a]||(this._routePermissions[a]={}),this._routePermissions[a][b.id]=d)},toJSON:function(){return{"public":this._publicPermissions,routes:this._routePermissions}}},d.Object=b.Model.extend(c.extend({},d.Access,{idAttribute:"_id",isStoredLocally:!1,storageKey:null,relations:{},set:function(a,d){return c.each(this.relations,function(c,e){var f=this[e],g;f||(a[e]&&(a[e]instanceof b.Model||a[e]instanceof b.Collection)?f=this[e]=a[e]:f=this[e]=new c),a[e]&&(a[e]instanceof b.Model||a[e]instanceof b.Collection?g=a[e].toJSON():g=a[e],f[f instanceof b.Collection?"reset":"set"](g,d),a[e]=f.toJSON())},this),a[this.idAttribute]&&c.isObject(a[this.idAttribute])&&c.has(a[this.idAttribute],"$id")&&(a[this.idAttribute]=a[this.idAttribute].$id),b.Model.prototype.set.call(this,a,d)},sync:function(a,b,c){return d.sync.call(this,a,b,c)},toJSON:function(){var a=c.clone(this.attributes);return c.each(c.keys(this.relations),function(b){a[b]=this[b].toJSON()},this),a}})),d.Resource=b.Collection.extend(c.extend({},d.Access,{operators:"$eq $in $or $gt $gte $lt $lte".split(" "),model:d.Object,find:function(a,b){var d;return!a||c.isEmpty(a)?this.models:(b=b||{},d=this.filter(function(b){for(var c in a)if(!this._evaluateCriteria(b,c,a[c],null))return!1;return!0},this),b.limit?c.first(d,b.limit):d)},findOne:function(a){var b=this.find(a);return b.length?b[0]:b},_evaluateCriteria:function(a,b,d,e){function f(a,b,c){if(!c)return a==b;switch(c){case"$eq":return a===b;case"$in":return a.indexOf(b)>=0;case"$or":return a||b;case"$gt":return a>b;case"$gte":return a>=b;case"$lt":return a<b;case"$lte":return a<=b;default:return!1}}if(c.isObject(d)&&a[b]){for(var g in d)if(!this._evaluateCriteria(a[b],g,d[g],e))return!1;return!0}return f(a.get(b),d,e)},load:function(a){var b;return a=a||{},b=a.success,a.success=c.bind(function(){this.trigger("load",this),b&&b()},this),this.fetch(a)}})),d.Cookie=d.Object.extend({initialize:function(){this.id=c.uniqueId(this.get("name"))},sync:function(a,b,c){var e=c.success,f=c.error,g=d.Cookies.get(this.get("name"));if(a==="create"||a==="update")return d.Cookies.set(this.get("name"),this.get("value"),this.get("expires"),this.get("path"),this.get("domain"),this.get("secure")),e&&e(!0),!0;if(a==="read")return e&&e(g),!0;if(a==="delete")return g&&d.Cookies.clear(this.get("name")),!0}}),d.Role=d.Object.extend({defaults:{name:"anonymous"},getName:function(){return this.get("name")},setName:function(a,b){return this.set("name",a,b)}}),d.User=d.Object.extend({loggedIn:!1,relations:{role:d.Role},isLoggedIn:function(){return this.loggedIn}}),d.Credentials=function(a,b){if(!a instanceof d.User)throw new Error("user must be an instance of Hitch.User");b=b||{}},d.Credentials.extend=e,d.Credentials.prototype=c.extend({},d.Object.prototype,{constructor:d.Credentials,userAttribute:"username",passAttribute:"password",cookie:{expires:!1,path:!1,domain:!1,secure:!1},validate:function(a){if(!a||!$.isPlainObject(a))return"invalid credentials.";if(!a[this.userAttribute])return"no "+this.userAttribute+" given.";if(!a[this.passAttribute])return"no "+this.passAttribute+" given."},initialize:function(a,b){b=b||{},b.user&&b.user instanceof d.User?this.user=b.user:this.user=new d.User,b.url&&(this.url=b.url),b.expires&&(this.cookie.expires=b.expires),b.path&&(this.cookie.path=b.path),b.domain&&(this.cookie.domain=b.domain),b.secure&&(this.cookie.secure=!!b.secure)},fetch:function(a){var b,e;return a=a||{},a.success&&(b=a.success),a.error&&(e=a.error),a.data=this.toJSON(),a.type="POST",a.success=c.bind(function(a){var e=c.compact(c.values(this.cookie));this.user.loggedIn=!0,this.user.set(a),d.Cookies.set.call(null,["hitch-user",this.user.id].concat(e)),b&&b(this,a)},this),a.error=c.bind(function(a){d.Cookies.clear("hitch-user"),this.user.loggedIn=!1,this.user.clear({silent:!0}),e&&e(this,a)},this),d.Object.prototype.fetch.call(this,a)},authenticate:function(a,b){if(!a instanceof d.User)throw new Error("user must be an instance of Hitch.User");var c=a.get(this.userAttribute),e=a.get(this.passAttribute),f={};c&&e&&(f[this.userAttribute]=c,f[this.passAttribute]=e,this.set(f,{silent:b.silent}),this.fetch(b))}}),d.Router=function(a){a=a||{},a.resource&&(this.resource=a.resource),a.routes&&(this.routes=a.routes),a.currentUser&&this.getCurrentUser(a.currentUser),this._bindFilters(),this._bindRoutes(),this.initialize.apply(this,arguments)},d.Router.extend=e,c.extend(d.Router.prototype,b.Router.prototype,d.Access,{constructor:d.Router,_displaySlots:{},_filters:{},onAfter:function(a,b,d){this._addFilter.apply(this,["after"].concat(c.toArray(arguments)))},onBefore:function(a,b,d){this._addFilter.apply(this,["before"].concat(c.toArray(arguments)))},route:function(a,d,e){return c.isRegExp(a)||(a=this._routeToRegExp(a)),e||(e=this[d]),b.history.route(a,c.bind(function(c){var f=this._extractParameters(a,c);this._applyFilters("before",c,f)&&(e&&e.apply(this,f),this._applyFilters("after",c,f),this.trigger.apply(this,["route:"+d].concat(f)),b.history.trigger("route",this,d,f))},this)),this},display:function(a,c){if(!$(a).length)throw new Error("No dom element found matching given selector: "+a);if(!c instanceof b.View)throw new Error("view must be an instance of Backbone.View");return this._displaySlots[a]&&this._displaySlots[a].close(),$(a).html(c.render().el),c.open(),this._displaySlots[a]=c,c},_addFilter:function(a,b,d,e){var f;this._filters[a]||(this._filters[a]={}),this._filters[a][b]||(f=this._filters[a][b]=[]),f[f.length]=c.bind(d,e||this)},_applyFilters:function(a,b,d){var e=a+"All",f=c.has(this,e)?this[e]:!1,g,h;return!this._filters[a]||c.isEmpty(this._filters[a])?!0:(g=c.filter(this._filters[a],function(a,d){return c.isRegExp(d)||(d=this._routeToRegExp(d)),d.test(b)},this),h=c.isEmpty(g)||!c.find(g,function(a,b){var e=[];return c.each(a,function(a){var b=c.isFunction(a)?a.apply(this,d):this[a].apply(this,d);e.push(c.isBoolean(b)&&b===!1)},this),c.compact(e).length===0},this),c.isFunction(f)&&(h=h&&f()),h)},_bindFilters:function(){for(var a in this.after)this._addFilter("after",a,this.after[a]);for(var b in this.before)this._addFilter("before",b,this.before[b])}}),b.history=b.history||new b.History,d.View=function(a){a&&a.resource&&(this.resource=a.resource),b.View.prototype.constructor.call(this,a)},d.View.extend=e,c.extend(d.View.prototype,b.View.prototype,{delegateBindings:function(){c.each(c.toArray(this.$("[data-bind]")),function(a){var b=$(a).data("bind"),c=$(a).data("bind-attribute");this.model.on("change:"+b,function(){c?$(a).attr(c,this.model.get(b)):$(a).html(this.model.get(b))},this)},this)},close:function(){this.beforeClose&&this.beforeClose(),this.undelegateEvents(),this.remove()},open:function(a){this.delegateEvents(),this.delegateBindings(),this.beforeOpen&&(this.$el.hide(),this.beforeOpen(c.bind(function(){this.$el.show()},this)))}}),d.App=function(a){a=a||{},$.isPlainObject(a)||(a=c.object(["name","apiUrl","baseRoute"],c.toArray(arguments))),a.apiUrl&&(this.apiUrl=a.apiUrl),a.baseRoute&&(this.baseRoute=a.baseRoute),a.name&&this.setName(a.name),c.isUndefined(a.exports)||(this.exports=!!a.exports),c.isRegExp(this.baseRoute)||(this.baseRoute=b.Router.prototype._routeToRegExp(this.baseRoute)),b.history.route(/^(.+?)$/,c.bind(function(a){var c=b.Router.prototype._extractParameters(/^(.*?)$/,a);this.error.apply(this,c),this.trigger.apply(this,["route:error"].concat(c)),b.history.trigger("route",this,"error",c)},this)),b.history.route(this.baseRoute,c.bind(function(a){var c=b.Router.prototype._extractParameters(this.baseRoute,a);this.index.apply(this,c),this.trigger.apply(this,["route:index"].concat(c)),b.history.trigger("route",this,"index",c)},this)),this.on("ready",this.ready,this),this.initialize.apply(this,arguments)},d.App.extend=e,c.extend(d.App.prototype,b.Events,{baseRoute:/^$/,apiUrl:"/",exports:!1,name:"app",setName:function(a){document&&document.title&&(document.title=a),this.name=a},appendAsset:function(a,b){a==="stylesheet"?$('<link rel="stylesheet" type="text/css" href="'+b+'">').appendTo("head"):a==="favicon"?$('<link rel="favicon" type="image/icon" href="'+b+'">').appendTo("head"):a==="javascript"&&$('<script type="text/javascript" src="'+b+'"></script>').appendTo("head")},load:function(a){var b,d=0;c.isArray(a)||(a=c.toArray(arguments)),b=a.length,this.resources={},b?c.each(a,function(a){c.isFunction(a)&&(a=new a),a.name||(a.name=c.uniqueId("r")),this.apiUrl&&(a.url=[this.apiUrl,a.name].join("/")),a.load({success:c.bind(function(){this.resources[a.name]=a,++d===b&&this.trigger("ready",this.resources)},this)})},this):this.trigger("ready",this.resources)},run:function(d){b.history.start(d),d.pushState&&$("a[href]").live("click",function(a){var c=$(this).attr("href");!$(this).attr("target")&&!/^(http\:\/\/|www\.)/.test(c)&&(a.preventDefault(),b.history.navigate(c,!0))});if(this.exports){var e=c.isString(this.exports)?this.exports:this.name;a[e]=this}},initialize:function(){},ready:function(){},index:function(){},error:function(){}}),d.sync=function(a,d,e){var f=e.success,g;return d.isStoredLocally?(d.storageKey||(d.storageKey=c.uniqueId("h")),g=localStorage.getItem(d.storageKey),a==="create"||a==="update"?(g=d.toJSON(),localStorage.setItem(d.storageKey,JSON.stringify(g))):a==="read"?g=g&&JSON.parse(g):a==="destroy"&&g&&localStorage.removeItem(d.storageKey),f&&f(g),!0):b.sync(a,d,e)}})).call(this);